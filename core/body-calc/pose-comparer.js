require("../../@babel/runtime/helpers/Arrayincludes");var e=require("../../@babel/runtime/helpers/createClass"),r=require("../../@babel/runtime/helpers/classCallCheck"),t=require("../../utils/utils"),i=require("../saber"),s=require("./limbs-map"),n=e((function e(){r(this,e),this.key=null,this.score=0,this.summary=null})),h=function(){return e((function e(){r(this,e),this.items=[],this.score=0}),[{key:"isPartSimilar",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.8;if(!e)throw new Error("partKey不能为空");if(r<0||r>1)throw new Error("critical值必须在0-1之间");var t=this.items.find((function(r){return r.key==e}));return!!t&&t.score>=r}}])}(),l=[{key:"head",keys:["left_shoulder+nose+left_hip","right_shoulder+nose+right_hip"],weight:1,summary:"头部偏转相似度"},{key:"trunk",keys:["right_shoulder+right_hip+left_shoulder","left_shoulder+left_hip+right_shoulder","right_hip+right_shoulder+left_hip","left_hip+left_shoulder+right_hip"],weight:2,isSide:!1,summary:"躯干形态相似度"},{key:"waist",keys:["right_hip+right_shoulder+right_knee","left_hip+left_shoulder+left_knee"],weight:1,summary:"腰部（弯腰）相似度"},{key:"left_hand",keys:["left_elbow+left_shoulder+left_wrist","left_shoulder+left_hip+left_wrist"],weight:1,summary:"左手相似度"},{key:"right_hand",keys:["right_elbow+right_shoulder+right_wrist","right_shoulder+right_hip+right_wrist"],weight:1,summary:"右手相似度"},{key:"left_foot",keys:["left_knee+left_hip+left_ankle","left_hip+right_ankle+left_ankle"],weight:1,summary:"左脚相似度"},{key:"right_foot",keys:["right_knee+right_hip+right_ankle","right_hip+left_ankle+right_ankle"],weight:1,summary:"右脚相似度"}],o=function(){return e((function e(){r(this,e)}),[{key:"compareAngle",value:function(e,r,t){var i=e.angleMap.find((function(e){return e.key==t})),s=r.angleMap.find((function(e){return e.key==t}));if(-1===i)return 1;if(!s)return 0;var n=s.angle-i.angle;return 0===n?1:(n=Math.abs(n),(n=1-(n/=i.angle))<0?0:n>1?1:n)}},{key:"compareBasic",value:function(e,r){if(!e.basicPosture)return null;var t=new n;return t.key="basic-posetrue",t.score=0,t.summary="人体基础姿态站/卧躺相似",e.basicPosture===r.basicPosture&&(t.score=1),t}},{key:"complexCompareAngle",value:function(e,r,i){if(t.isEmptyArray(i))throw new Error("请至少指定个部分角key");var s=0,n=this;return i.forEach((function(t){s+=n.compareAngle(e,r,t)})),s/=i.length}},{key:"compare",value:function(e,r,i){if(t.isEmptyArray(e))throw new Error("样本Points不能为空");if(t.isEmptyArray(r))throw new Error("比较Points不能为空");if(i&&!1===["left","right"].includes(i))throw new Error("side参数只接受left或right");var o=new h,a=0,u=0,f=new s(e),y=new s(r),c=this.compareBasic(f,y);c&&(u++,a+=c.score,o.items.push(c));var g=null;i&&(g="right"==i?"left_":"right_");var m=this;return l.forEach((function(e){if(!g||!1!==e.isSide&&!e.key.startsWith(g)){var r=e.keys.filter((function(e){return!e.startsWith(g)})),t=new n;t.key=e.key,t.score=m.complexCompareAngle(f,y,r),t.summary=e.summary,o.items.push(t),a+=t.score*e.weight,u+=e.weight}})),o.score=a/u,o}},{key:"isSimilar",value:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.85,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;e&&!Array.isArray(e)&&(e=e.keypoints),r&&!Array.isArray(r)&&(r=r.keypoints);try{var n=this.compare(e,r,s),h=n.score>=t;return i.writeConsoleLog("相似确认结果：",h,n,t),h}catch(e){console.warn("pose-comparer",e)}}}])}();module.exports={PoseComparerPartItem:n,PoseComparerResult:h,PoseComparer:o};