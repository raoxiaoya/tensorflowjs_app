var t=require("../@babel/runtime/helpers/classCallCheck"),e=require("../@babel/runtime/helpers/createClass"),s=require("../utils/utils"),i=function(){return e((function e(){t(this,e),this.fps=0,this.targetFPS=12,this.frames=[],this.frameCount=0,this.onFrame=null,this.onStatusChange=null}),[{key:"_onEmitFrame",value:function(){if(-1!==this._signal){var t=this.frames.shift();t&&s.invoke(this.onFrame)(t),t||0!==this._signal||(console.debug("相机停止推帧"),this._signal=-1,s.invoke(this.onStatusChange)(-1,this.getStatus()))}}},{key:"_isFlowControl",value:function(){var t=(new Date).getTime();return!this._lastStamp||s.isEmptyArray(this.frames)?(this._lastStamp=t,!1):t-this._lastStamp<1e3/this.targetFPS||(this._lastStamp=t,!1)}},{key:"_onFrame",value:function(t){if(1==this._signal&&(this.frameCount++,!this._isFlowControl())){var e={data:new Uint8Array(t.data),width:Number(t.width),height:Number(t.height),timestamp:(new Date).getTime()};if(this.frames.push(e),this._startTime){var i=s.timestamp();this.fps=this.frameCount/(i-this._startTime),this.fps=Math.floor(this.fps)}else this._startTime=s.timestamp()}}},{key:"_createListener",value:function(){var t=this,e=wx.createCameraContext().onCameraFrame((function(e){return t._onFrame(e)}));e.start(),this._listener=e}},{key:"getStatus",value:function(){switch(this._signal){case-1:return"stopped";case 0:return"stopping";case 1:return"running";default:return"unknown"}}},{key:"start",value:function(){var t=this;this.frameCount=0,this._signal=1,this._startTime=null,this._lastStamp=-1,this._listener||this._createListener(),this._emitThread||(this._emitThread=setInterval((function(){return t._onEmitFrame()}),1e3/this.targetFPS)),s.invoke(this.onStatusChange)(1,this.getStatus())}},{key:"stop",value:function(){1===this._signal&&(this._signal=0,s.invoke(this.onStatusChange)(0,this.getStatus()))}},{key:"dispose",value:function(){this._listener&&(this._emitThread&&(clearInterval(this._emitThread),this._emitThread=null),this._listener.stop(),this._listener=null,this._signal=-1)}}])}();module.exports=i;