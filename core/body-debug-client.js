var e=require("../@babel/runtime/helpers/classCallCheck"),t=require("../@babel/runtime/helpers/createClass"),n=require("../utils/utils"),s=require("./saber"),i=function(){return t((function t(n){if(e(this,t),this._socket=null,this.url="http://192.168.10.10:20231/",this.queueSize=512,this.queues=[],!n)throw Error("url不能为空");n.endsWith("/")||(n+="/"),this.url=n}),[{key:"testAsync",value:function(){var e=this;return new Promise((function(t,n){wx.request({url:"".concat(e.url,"api/body-push-back/hi"),method:"GET",success:function(e){t(!0)},fail:function(e){s.writeConsoleError("工具连接失败",e),t(!1)}})}))}},{key:"isConnected",value:function(){return!!this._socket&&1==this._socket.readyState}},{key:"connect",value:function(e){if(this._socket)throw new Error("当前连接未释放，不要重复打开。");var t=this.url;t.startsWith("http://")&&(t="ws:"+t.substr(5)),this._socket=wx.connectSocket({url:"".concat(t,"body-sync"),perMessageDeflate:!0,timeout:6e4,success:function(e){},fail:function(e){s.writeConsoleError("运动生成调试工具 连接失败",e)}});var i=this;this._socket.onOpen((function(){s.writeConsoleLog("连接 运动生成调试工具 连接成功。"),n.invoke(e)()})),this._socket.onClose((function(){i._socket=null})),this._socket.onMessage((function(e){i.onReceive(e)})),this._socket.onError((function(e){console.error(e)}))}},{key:"connectAsync",value:function(){var e=this;return new Promise((function(t,n){var s=null;e.connect((function(){clearTimeout(s),t()})),s=setTimeout((function(){n(new Error("连调试工具超时，请检查工具服务器是否开启。"))}),3e4)}))}},{key:"enqueue",value:function(e,t){this.queues.length>=this.queueSize&&this.queues.shift(),this.queues.push({frame:{width:e.width,height:e.height,rawData:e.rawData.slice(0)},human:t.toSimpleObject?t.toSimpleObject():n.clone(t)})}},{key:"onReceive",value:function(e){if(this.current){var t=this.current,i=t.human;i.frameId=e.data,i.width=t.frame.width,i.height=t.frame.height,this.current=null;var r=this;r._socket.send({data:JSON.stringify(i),success:function(){-1!==n.invoke(t.progressFn)(t.index,t.total)&&t.index!=t.total&&setTimeout((function(){r.syncing(t.progressFn,t.index,t.total)}),300)},fail:function(e){s.writeConsoleError("发送识别结果失败",e),n.invoke(t.progressFn)(-1,-1)}})}}},{key:"syncing",value:function(e,t,i){if(!this._socket)throw new Error("请先调用connect()打开连接");if(n.isEmptyArray(this.queues))n.invoke(e)(0,0);else{i=i||this.queues.length,t=t||0,t++,this.current=this.queues.shift(),this.current.progressFn=e,this.current.index=t,this.current.total=i;var r=this;this._socket.send({data:r.current.frame.rawData,fail:function(e){r.currentFrame=null,s.writeConsoleError("发送帧失败",e)}})}}},{key:"close",value:function(){this._socket&&(this._socket.close(),this._socket=null)}}])}();module.exports=i;