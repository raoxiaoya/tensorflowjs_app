var e=require("../@babel/runtime/helpers/regeneratorRuntime"),t=require("../@babel/runtime/helpers/asyncToGenerator"),n=(require("../@babel/runtime/helpers/createClass"),require("../@babel/runtime/helpers/classCallCheck"),require("../utils/utils")),r=require("./saber"),i=require("../mini-tfjs/reduce-tfjs"),o=i.wechatExtensions,a=i.moveNet,c=require("./vision-kit"),s=require("./body-detection-result"),u=require("./realtime-logger"),l=0,f=null,h=new u("human-detection"),v=0;function m(){return"wasm"==o.getBackend()}function d(e){return k.apply(this,arguments)}function k(){return(k=t(e().mark((function t(r){var i;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=o.WECHAT_WEBGL_BACKEND_NAME,r.enhanced&&(i="wasm"),i==o.getBackend()){e.next=7;break}return a.dispose(),f=null,e.next=7,o.changeBackend(i);case 7:if(!f){e.next=11;break}return l=1,n.invoke(r.callback)(),e.abrupt("return");case 11:a.loadModel("lightning",(function(e,t){f=e,e&&(l=1,h.info("initVe1","成功初始化引擎ve1")),n.invoke(r.callback)(t)}));case 12:case"end":return e.stop()}}),t)})))).apply(this,arguments)}function p(e){if(c.isSupport())try{c.getOrCreateSesion();l=2,h.info("initVe2","成功初始化引擎ve2"),n.invoke(e)()}catch(t){r.writeConsoleError(t),h.error("initVe2",t),n.invoke(e)(t)}else n.invoke(e)(new Error("当前环境不支持ve2引擎"))}module.exports={getVe:function(){return l},isEnhanced:m,initialize:function(e){switch(l=0,(e=e||{}).ve=e.ve||0,e.ve){case 1:d(e);break;case 2:p(e.callback);break;default:var t=e.callback;e.callback=function(e){e?p(t):n.invoke(t)(e)},d(e)}},BodyDetectionResult:s,detectionAsync:function(e){if(!l)throw new Error("未初始化识别引擎，请先调用initialize()");if(!e)throw new Error("frame不能为空");return 1==l?function(e){if(!f)throw new Error("ve1未初始，请先调用initialize()");return new Promise((function(t,n){var r=(new Date).getTime();f.estimatePoses(e).then((function(n){if(!n||n.length<1)t(null);else{-1!=v&&v++;var i=new s;if(i.keypoints=n[0].keypoints,i.score=n[0].score,i.width=e.width,i.height=e.height,i.timestamp=e.timestamp,v>=12){var o=(new Date).getTime(),a=Math.ceil(1e3/(o-r)),c=m()?"-增强":"";h.info("moveNetDetectAsync","成功使用ve1".concat(c,"连续识别了").concat(v,"帧，FPS：").concat(a)),v=-1}t(i)}})).catch((function(e){h.error("moveNetDetectAsync",e),n(e)}))}))}(e):c.detectionAsync(e)},dispose:function(){a.dispose(),c.destroy(),l=0,f=null}};