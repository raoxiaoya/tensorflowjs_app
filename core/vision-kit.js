require("../config");var e=require("../utils/utils"),t=require("./saber"),r=require("./body-detection-result"),i=new(require("./realtime-logger"))("vision-kit"),n=["nose","left_eye","right_eye","left_ear","right_ear","left_shoulder","right_shoulder","left_elbow","right_elbow","left_wrist","right_wrist","left_hip","right_hip","left_knee","right_knee","left_ankle","right_ankle","left_palm","right_palm","left_tiptoe","right_tiptoe","left_heel","right_heel"],o=null,s=null,a=0;function c(){return void 0===wx.isVKSupport?-1:wx.isVKSupport("v2")?2:1}function u(o){if(t.writeConsoleDebug("on detect"),s){if(-1!=a&&a++,a>=12){var c=(new Date).getTime(),u=Math.ceil(1e3/(c-s.frame.timestamp));i.info("onDetection","成功使用ve2连续识别了".concat(a,"帧，FPS：").concat(u)),a=-1}var h=null;e.isEmptyArray(o)||(h=function(e,t){if(!e)throw new Error("anchor不能为空");var i=new r;i.detectId=e.detectId,i.score=e.score,i.width=t.width,i.height=t.height,i.timestamp=t.timestamp;var o={beginX:t.width*e.origin.x,beginY:t.height*e.origin.y};o.endX=o.beginX+t.width*e.size.width,o.endY=o.beginY+t.height*e.size.height;var s=!1,a=1e8;return i.keypoints=[],e.points.some((function(r,c){if(c>16)return!0;var u,h,l={x:r.x,y:r.y};if("string"==typeof l.x&&(l.x=parseFloat(l.x),l.x=Math.round(l.x*a)/a),"string"==typeof l.y&&(l.y=parseFloat(l.y),l.y=Math.round(l.y*a)/a),l.x*=t.width,l.y*=t.height,u=o,(h=l).x<u.beginX-5||h.x>u.endX+5||h.y<u.beginY-5||h.y>u.endY+5)return s=!0,!0;l.name=n[c],l.score=e.confidence[c],"string"==typeof l.score&&(l.score=parseFloat(l.score),l.score=Math.round(l.score*a)/a),i.keypoints.push(l)})),i.anchor={size:{width:e.size.width,height:e.size.height},origin:{x:e.origin.x,y:e.origin.y},points:e.points.map((function(e){return e}))},s?null:i}(o[0],s.frame)),e.invoke(s.fn)(h)}else t.writeConsoleDebug("识别帧丢失")}function h(){return!!o&&(1===o.state||3===o.satet||(t.writeConsoleError("ve2状态：".concat(o.state)),i.error("sessionIsAvailable","ve2状态异常：".concat(o.state)),!1))}function l(){var r=c();if(!r)throw Error("当前小程序环境不支持ve2号识别引擎。");return o||(t.writeConsoleDebug("ve2",r),(o=wx.createVKSession({version:"v".concat(r),track:{body:{mode:2}}})).on("updateAnchors",u),o.on("removeAnchors",(function(){s&&e.invoke(s.fn)(null)})),o.start((function(e){if(e)throw new Error("ve2号识别引擎启动失败，错误代码".concat(e));t.writeConsoleDebug("ve2识别引擎启动成功。"),i.debug("createSession","ve2引擎启动成功，版本号".concat(r))})),o)}function f(){o&&(o.stop(),o.destroy(),o=null)}module.exports={isSupport:c,createSession:l,getOrCreateSesion:function(){return h()||(f(),l()),o},detectionAsync:function(e){if(!e)throw new Error("frame不能为空。");if(s)return Promise.reject({code:1001,message:"识别中，请待上一帧识别完成"});if(!h())return Promise.reject({code:1e3,message:"当前识别引擎不可用，请确认是否初始化成功"});s={frame:e};var r=new Promise((function(e,r){try{var n=setTimeout((function(){s=null,e(null)}),200);s.fn=function(t){s=null,clearTimeout(n),e(t)}}catch(e){t.writeConsoleError(e),i.error("detectionAsync",e),r(e)}}));return o.detectBody({frameBuffer:e.rawData,width:e.width,height:e.height,sourceType:0}),r},destroy:f};